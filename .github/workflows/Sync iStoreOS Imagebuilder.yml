name:  ğŸ’¿ Sync iStoreOS Imagebuilder

on:
  workflow_dispatch:      

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Remote Date and Check Local
        id: parse
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_URL="https://fw0.koolcenter.com/iStoreOS/ib/armsr/"
          TARGET_FILE="istoreos-imagebuilder-armsr-armv8.Linux-x86_64.tar.zst"
          
          # 1. è·å–åŒ…å«æ–‡ä»¶åçš„è¡Œ
          LINE_CONTENT=$(curl -sL $BASE_URL | grep "$TARGET_FILE" | head -n 1)
          
          # 2. æå–æ—¥æœŸ (YYYY-MM-DD)
          RAW_DATE=$(echo "$LINE_CONTENT" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
          
          if [ -z "$RAW_DATE" ]; then
            echo "::error::æ— æ³•åœ¨é¡µé¢è¡Œå†…è¯†åˆ«æ—¥æœŸæ ¼å¼"
            exit 1
          fi

          # 3. æ ¼å¼åŒ–å¹¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶å
          RELEASE_DATE=$(date -d "$RAW_DATE" +%Y%m%d)
          FILENAME="${RELEASE_DATE}-${TARGET_FILE}"
          
          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "url=${BASE_URL}${TARGET_FILE}" >> $GITHUB_OUTPUT

          # 4. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          EXISTS=$(gh release view iStoreOS-Imagebuilder --json assets --jq ".assets[].name" 2>/dev/null | grep -w "$FILENAME" || true)

          if [ "$EXISTS" = "$FILENAME" ]; then
            echo "skip_upload=true" >> $GITHUB_OUTPUT
            echo "âœ… æ–‡ä»¶ $FILENAME å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤åŒæ­¥ã€‚"
          else
            echo "skip_upload=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬æˆ–ç¼ºå¤±ç‰ˆæœ¬: $FILENAME"
          fi

      - name: Download File
        if: steps.parse.outputs.skip_upload == 'false'
        run: |
          echo "æ­£åœ¨ä»å®˜ç½‘æ‹‰å–: ${{ steps.parse.outputs.filename }}"
          # ä½¿ç”¨ -C - å¼€å¯æ–­ç‚¹ç»­ä¼ ï¼Œé˜²æ­¢å¤§æ–‡ä»¶ä¸‹è½½ä¸­æ–­
          curl -L -C - "${{ steps.parse.outputs.url }}" -o "${{ steps.parse.outputs.filename }}"

      - name: Upload to Release
        if: steps.parse.outputs.skip_upload == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-Imagebuilder
          files: ${{ steps.parse.outputs.filename }}
          body: |
            ## iStoreOS Imagebuilder è‡ªåŠ¨åŒæ­¥
            - **æºæ–‡ä»¶æ—¥æœŸ**: ${{ steps.parse.outputs.date }}
            - **åŒæ­¥æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
            - **å®˜æ–¹åœ°å€**: [Koolcenter](https://fw0.koolcenter.com/iStoreOS/ib/armsr/)
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
