name: ğŸ“¦ Build iStoreOS 24.10.X x86_64

on:
  workflow_dispatch:
    inputs:
      build_version:
        description: "è¯·é€‰æ‹©æ„å»ºç‰ˆæœ¬ (latest ä¸ºå®˜ç½‘æœ€æ–°)"
        required: true
        default: 'latest'
        type: choice
        options:
          - 'latest'
          - '20251205'
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: true
        default: "24.10.4"
        type: choice
        options:
          - '24.10.0'
          - '24.10.1'
          - '24.10.2'
          - '24.10.3'
          - '24.10.4' 
      include_docker:
        description: |
          æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set executable permissions
      run: | 
        chmod +x x86/build_config.sh
        chmod +x shell/*.sh
        
        
    - name: âš™ï¸ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip tree


    - name: â¬ ä¸‹è½½ ImageBuilder
      run: |
        BUILD_VER="${{ inputs.build_version }}"
        if [ "$BUILD_VER" = "latest" ]; then
          URL="https://fw0.koolcenter.com/iStoreOS/ib/x86_64/istoreos-imagebuilder-x86-64.Linux-x86_64.tar.zst"
        else
          URL="https://github.com/${{ github.repository }}/releases/download/iStoreOS-Imagebuilder/${BUILD_VER}-istoreos-imagebuilder-x86-64.Linux-x86_64.tar.zst"
        fi
        curl -Lf -o imagebuilder.tar.zst "$URL"
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder
        
    
    - name: â¬ å¤åˆ¶å¿…å¤‡æ–‡ä»¶
      run: |
        cp x86/build_config.sh imagebuilder/
        cp x86/Makefile imagebuilder/
        cp x86/repositories.conf imagebuilder/
        cp shell/prepare-packages.sh imagebuilder/
        cp shell/custom-packages.sh imagebuilder/
        mkdir -p imagebuilder/files/etc/uci-defaults
        cp files/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        echo "æ‰“å°actionç›®å½•ç»“æ„"
        tree -L 1

    - name: ğŸ§± æ„å»ºiStoreOSå›ºä»¶
      working-directory: ./imagebuilder
      run: |
        echo "æ‰“å°imagebuilderç›®å½•ç»“æ„"
        tree -L 1
        echo "æ‰“å°repositories"
        cat repositories.conf
        echo "æ‰“å°Makefile"
        cat Makefile |grep here
        bash ./build_config.sh

    - name: ğŸ“¦ æ‰“å°äº§å‡ºå›ºä»¶
      run: |
        echo "æ‰“å°binç›®å½•"
        ls -lah imagebuilder/bin/targets/x86/64/

    - name: ğŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-x86-64-${{ inputs.luci_version }}
        files: |
          imagebuilder/bin/targets/x86/64/*squashfs-combined-efi.img.gz
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

