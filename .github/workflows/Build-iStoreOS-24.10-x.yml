name: ğŸ“¦ Build iStoreOS_x86_64 24.10.x

on:
  workflow_dispatch:
    inputs:
      build_version:
        description: "è¯·é€‰æ‹©æ„å»ºç‰ˆæœ¬ (latest ä¸ºå®˜ç½‘æœ€æ–°)"
        required: true
        default: 'latest'
        type: choice
        options:
          - 'latest'
          - '20251231'   
          - '20251226'
          - '20251205'          
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: true
        default: "24.10.4"
        type: choice
        options:
          - '24.10.0'
          - '24.10.1'
          - '24.10.2'
          - '24.10.3'
          - '24.10.4' 
      ipaddr:
        description: 'è¯·è¾“å…¥ç®¡ç†IP'
        required: true
        default: '192.168.5.1'
      include_docker:
        description: |
          æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

env:
  VERSION: ${{ inputs.luci_version }}

jobs:
  build:
    runs-on: ubuntu-22.04
    # å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œè§£å†³ 403 æŠ¥é”™
    permissions:
      contents: write
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3

    - name: âš™ï¸ è®¾ç½®å¯æ‰§è¡Œæƒé™
      run: | 
        chmod +x x86/build_config.sh
        chmod +x shell/*.sh
             
    - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev zstd curl unzip tree qemu-utils genisoimage

    - name: âš™ï¸ è®¾ç½®IPã€ç½‘å…³å’Œç‰ˆæœ¬å·
      run: |
        CONFIG_PATH="./files/uci-defaults/99-custom.sh"
        echo "å½“å‰ç½‘ç»œé…ç½®è·¯å¾„: $CONFIG_PATH"
        
        # 1. æ›¿æ¢ç‰ˆæœ¬å·å ä½ç¬¦
        sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "$CONFIG_PATH"
        [ -f "./files/etc/banner" ] && sed -i "s/ç‰ˆæœ¬å·/${{ env.VERSION }}/g" "./files/etc/banner"

        # 2. ç½‘ç»œé€»è¾‘é…ç½® (å…³é”®ä¿®æ”¹ç‚¹ï¼šä¸å†åˆ é™¤è¡Œï¼Œæ”¹ç”¨å…³é”®è¯æ›¿æ¢)
        sed -i "s/__IPADDR__/${{ inputs.ipaddr }}/g" "$CONFIG_PATH"

        # 3. æ›¿æ¢è„šæœ¬æœ«å°¾çš„æè¿°ä¿¡æ¯
        sed -i "s/VERXXXX/${{ env.VERSION }}/g" "$CONFIG_PATH"
        
        echo "âœ… é…ç½®ä¿®æ”¹å®Œæˆï¼Œè¾“å‡ºé¢„è§ˆï¼š"
        cat "$CONFIG_PATH"


    - name: â¬ ä¸‹è½½ ImageBuilder
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BUILD_VER="${{ inputs.build_version }}"
        REPO="${{ github.repository }}"
        TAG="iStoreOS-Imagebuilder"
        TARGET_SUFFIX="istoreos-imagebuilder-x86-64.Linux-x86_64.tar.zst"

        if [ "$BUILD_VER" = "latest" ]; then
          echo "ğŸ” æ­£åœ¨ä»ä½ çš„ GitHub Release ä¸­å¯»æ‰¾æœ€æ–°å¤‡ä»½..."
          
          # è·å–èµ„äº§åˆ—è¡¨ -> è¿‡æ»¤å‡º imagebuilder æ–‡ä»¶ -> æŒ‰åç§°å€’åºæ’åº -> å–ç¬¬ä¸€ä¸ª
          LATEST_FILE=$(gh release view "$TAG" --repo "$REPO" --json assets --jq '.assets[].name' | grep "$TARGET_SUFFIX" | sort -r | head -n 1)
          
          if [ -z "$LATEST_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šåœ¨ Release æ ‡ç­¾ $TAG ä¸‹æ²¡æ‰¾åˆ°ä»»ä½•å¤‡ä»½æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥åŒæ­¥ Workflow æ˜¯å¦æˆåŠŸè¿è¡Œè¿‡ã€‚"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ°æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶: $LATEST_FILE"
          URL="https://github.com/$REPO/releases/download/$TAG/$LATEST_FILE"
        else
          echo "å›ºå®šç‰ˆæœ¬æ¨¡å¼ï¼šå‡†å¤‡ä¸‹è½½ $BUILD_VER å¤‡ä»½"
          URL="https://github.com/$REPO/releases/download/$TAG/${BUILD_VER}-${TARGET_SUFFIX}"
        fi

        echo "æ­£åœ¨ä¸‹è½½: $URL"
        # ä½¿ç”¨ -f ç¡®ä¿å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æ—¶æŠ¥é”™åœæ­¢ï¼Œè€Œä¸æ˜¯ä¸‹è½½ä¸€ä¸ªé”™è¯¯é¡µé¢
        curl -Lf -o imagebuilder.tar.zst "$URL"
        
        # è§£å‹
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        # è¿™é‡Œçš„è§£å‹ç›®å½•åŒ¹é…å®˜æ–¹é»˜è®¤ç”Ÿæˆçš„æ–‡ä»¶å¤¹å
        mv istoreos-imagebuilder-* imagebuilder       
    
    - name: ğŸ”„ å¤åˆ¶å¿…å¤‡æ–‡ä»¶
      run: |
        cp x86/build_config.sh imagebuilder/
        cp x86/Makefile imagebuilder/
        cp x86/repositories.conf imagebuilder/
        cp shell/prepare-packages.sh imagebuilder/
        cp shell/custom-packages.sh imagebuilder/
        mkdir -p imagebuilder/files/etc/uci-defaults
        cp files/uci-defaults/99-custom.sh imagebuilder/files/etc/uci-defaults/
        mkdir -p imagebuilder/files/etc/opkg
        cp -r files/customfeeds/* imagebuilder/files/etc/opkg/ 2>/dev/null || true
        # éªŒè¯ä¿¡æ¯
        ls -l imagebuilder/files/etc/opkg/customfeeds.conf && echo "å·²æ‹·è´ customfeeds.conf"
        
        echo "æ‰“å°actionç›®å½•ç»“æ„"
        tree -L 1

    - name: âš™ï¸ åŠ¨æ€è·å– Kmod å“ˆå¸Œå¹¶æ›´æ–°é…ç½®
      run: |
        BUILD_VER="${{ env.VERSION }}"
        BASE_URL="https://downloads.openwrt.org/releases/${BUILD_VER}/targets/x86/64/kmods/"
        
        echo "æ­£åœ¨ä» $BASE_URL è·å–æœ€æ–°çš„å†…æ ¸å“ˆå¸Œ..."
        # æŠ“å–åŒ…å«å“ˆå¸Œå€¼çš„æ–‡ä»¶å¤¹åç§° (ä¾‹å¦‚ 6.6.110-1-xxx...)
        KMOD_DIR=$(curl -sL $BASE_URL | grep -oE "[0-9.-]+-[a-f0-9]{32}" | head -n 1)
        
        if [ -n "$KMOD_DIR" ]; then
          FULL_KMOD_URL="${BASE_URL}${KMOD_DIR}"
          echo "âœ… æˆåŠŸåŒ¹é… kmods è·¯å¾„: $FULL_KMOD_URL"
          
          # 1. æ›¿æ¢ç‰ˆæœ¬å ä½ç¬¦
          sed -i "s|VERSION_PLACEHOLDER|${BUILD_VER}|g" imagebuilder/repositories.conf
          # 2. æ›¿æ¢ Kmod å®Œæ•´è·¯å¾„
          sed -i "s|https://.*/kmods/KMOD_PLACEHOLDER|$FULL_KMOD_URL|g" imagebuilder/repositories.conf
        else
          echo "âŒ æ— æ³•è·å– Kmod å“ˆå¸Œï¼Œè¯·æ£€æŸ¥å®˜æ–¹æºæ˜¯å¦å­˜åœ¨è¯¥ç‰ˆæœ¬: $BASE_URL"
          exit 1
        fi
        
        echo "--- æ£€æŸ¥æ›´æ–°åçš„ repositories.conf ---"
        cat imagebuilder/repositories.conf | grep "https"

    - name: ğŸ§± æ„å»ºiStoreOSå›ºä»¶
      working-directory: ./imagebuilder
      run: |
        echo "æ‰“å°imagebuilderç›®å½•ç»“æ„"
        tree -L 1
        echo "æ‰“å°repositories"
        cat repositories.conf
        echo "æ‰“å°Makefile"
        cat Makefile |grep here
        bash ./build_config.sh

    - name: ğŸ” æ‰“å°imagebuilderç›®å½•ç»“æ„å¹¶é‡å‘½åå›ºä»¶ä¿¡æ¯
      run: |
        echo "--- åŸå§‹æ–‡ä»¶åˆ—è¡¨ ---"
        ls -lah imagebuilder/bin/targets/x86/64/
        
        # è¿›å…¥ç›®æ ‡ç›®å½•
        cd imagebuilder/bin/targets/x86/64/
        
        for f in *squashfs-combined-efi.img.gz; do
          if [ -f "$f" ]; then
            echo "æ­£åœ¨é‡å‘½å $f ä¸º ${{ github.event.inputs.luci_version }}-$f"
            mv "$f" "${{ github.event.inputs.luci_version }}-$f"
          fi
        done
        
        echo "--- æ”¹ååæ–‡ä»¶åˆ—è¡¨ ---"
        ls -lah .

    - name: ğŸ“œ ç”Ÿæˆè·¯ç”±å™¨åå°åŸºæœ¬ä¿¡æ¯
      run: |
          # 1. å…ˆåˆ›å»ºåŸºç¡€ä¿¡æ¯åˆ°æ–‡ä»¶
          cat > ${{ github.workspace }}/router-info.md <<EOF
          ## ğŸ“¡ è·¯ç”±å™¨åå°ä¿¡æ¯
          
          ğŸ“Œ ç‰ˆæœ¬ï¼š iStoreOS-x86-64-${{ github.event.inputs.luci_version }}
          
          ğŸ§© é›†æˆï¼š åŒ…å«äº†åŸºç¡€ç³»ç»Ÿç»„ä»¶ã€é©±åŠ¨ã€ç½‘ç»œå·¥å…·ã€å®¹å™¨æ”¯æŒã€LuCIç•Œé¢åŠæ’ä»¶ç­‰
          
          ğŸ‘¤ ç”¨æˆ·åï¼š root
          
          ğŸ”’ å¯†ç ï¼š æ— 
          
          ğŸŒ åˆå§‹IPï¼š ${{ github.event.inputs.ipaddr }}
          
          EOF

          # 2. æ ¹æ®åˆ¤æ–­è¿½åŠ  Docker çŠ¶æ€
          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            echo "ğŸ“œ **Docker çŠ¶æ€**: å·²é›†æˆ" >> ${{ github.workspace }}/router-info.md
          else
            echo "ğŸ“œ **Docker çŠ¶æ€**: æœªé›†æˆ" >> ${{ github.workspace }}/router-info.md
          fi

    - name: ğŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2.2.1
      with:
        tag_name: iStoreOS-${{ github.event.inputs.luci_version }}-x86-64-RELEASE
        # 3. ä½¿ç”¨ body_path è¯»å–åˆšæ‰ç”Ÿæˆçš„æ–‡ä»¶å†…å®¹
        body_path: ${{ github.workspace }}/router-info.md
        files: |
          imagebuilder/bin/targets/x86/64/*squashfs-combined-efi.img.gz
          imagebuilder/bin/targets/x86/64/sha256sums
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
